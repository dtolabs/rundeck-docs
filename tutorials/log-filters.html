<!DOCTYPE html>
<html>
<head>
  <title>Using Log Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="generator" content="pandoc" />
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="../jquery.hotkeys.js"></script>
<script src="../jquery.autocomplete.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript">
window._pageRelpath="../";
jQuery(function(){
  jQuery('table').addClass('table table-condensed table-responsive'); 
  jQuery('[data-toggle="popover"]').popover();
});
</script>
<script src="../docs-autocomplete.js"></script>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../style.css" type="text/css" />
</head>
<body data-spy="scroll" data-target=".toc-nav">
<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="container-fluid">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="https://www.rundeck.com/open-source">
      Rundeck
      <p class="small rd_version">← Return to Rundeck Project</p>
    </a>
  </div>
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <form class="navbar-form navbar-right" role="search"  action="/search/">
      <div class="form-group">
        <input type="text" class="form-control navquery" name="q" placeholder="Search" id="searchQuery">
      </div>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>
  </div>
  </div>
</nav>

<div class="container top breadcrumb_holder">
<div class="row">
<div class="col-sm-6" id="#breadcrumbstop">

<div class="navquerytoggle collapse" aria-expanded="false">
<div class="input-group ">
    <a class="input-group-addon btn btn-xs" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbstop"><i class="glyphicon glyphicon-search"></i></a>
    <input type="text" class="form-control navquery  " name="q" placeholder="Search" autofocus="true">    
    <a class="input-group-addon btn btn-xs" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbstop"><i class="glyphicon glyphicon-remove"></i></a>
</div>
</div>

<ol class="breadcrumb top collapse in navquerytoggle" aria-expanded="true">
    <li class="navquerytrigger collapse" title="Find a page by name. (Keyboard shortcut: q)" data-toggle="tooltip" data-container="body">
        <a class="btn btn-xs btn-link" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbstop">
            <i class="glyphicon glyphicon-search"></i>
        </a>
    </li>

    
        <li><a href="../index.html">Rundeck Documentation (3.0.x)</a></li>
    
    
    <li ><a href="index.html">Tutorials</a></li>
    <li class="active"><a href="log-filters.html">Log Filters</a></li>
</ol>
</div>
<div class="col-sm-6">
    <ul class="pager">
      <li class="previous"><a href="custom-script-plugin---db-credential-rotation.html"><i class="glyphicon glyphicon-arrow-left"></i> Custom Script Plugin - DB Credential Rotation</a></li>
      <li class="next"><a href="java-plugin.html">Java Plugin <i class="glyphicon glyphicon-arrow-right"></i></a></li>
    </ul>
</div>
</div>
<div class="row">
<div class="col-sm-12 text-right">
    <a class="btn btn-link top" href="https://github.com/rundeck/docs/issues/new?labels=bug&title=Documentation+bug+in+file+tutorials/log-filters.md&template=documentation-bug.md"><i class="glyphicon glyphicon-flag"></i> Report a problem</a>
    <a class="btn btn-link top btn-edit-this-page" href="https://github.com/rundeck/docs/edit/3.0.x/en/tutorials/log-filters.md"><i class="glyphicon glyphicon-pencil"></i>  Edit this page</a>
</div>
</div>
</div>
<div id="docbody">
<div class="container">
<div class="row">
<div class="col-sm-3 toc-nav">
<div class="nav">
<ul>
<li><a href="#use-case-packaging-and-distributing-a-binary">Use case: packaging and distributing a binary</a></li>
<li><a href="#building-the-package">Building the package</a></li>
<li><a href="#wrap-the-build-script-in-a-custom-script-step-plugin">Wrap the build script in a custom script step plugin</a></li>
<li><a href="#create-the-job">Create the job</a></li>
<li><a href="#highlighting-high-level-log-output">Highlighting high level log output</a></li>
<li><a href="#prevent-accidental-leakage-of-secrets">Prevent accidental leakage of secrets</a></li>
<li><a href="#running-jobs-on-different-sets-of-nodes">Running jobs on different sets of nodes</a></li>
<li><a href="#passing-data-from-one-job-to-another">Passing data from one job to another</a></li>
</ul>
</div>
</div>
<div class="col-sm-9">
<div class="page-header">
<h1 class="title">Using Log Filters</h1>
</div>
<p>In this tutorial we’ll learn how to use Rundeck’s log filters to</p>
<ul>
<li>Capture key value data for use in subsequent jobs</li>
<li>Highlight important output to improve job output readability</li>
<li>Suppress potentially sensitive information from leaking into the logs</li>
</ul>
<h2 id="use-case-packaging-and-distributing-a-binary">Use case: packaging and distributing a binary</h2>
<p>To illustrate the log filter functionality, we’ll create a project to package and distribute a binary. We’ll be using the <a href="https://github.com/clofresh/rundeck-playground">Rundeck Playground</a> environment to simulate a data center locally on your workstation.</p>
<p>A common workflow for distributing binaries is to create an OS package on a builder machine that’s optimized for packaging code, upload the built package to a package repository, and then have the destination machines pull the latest version of the package from the repository. In this tutorial, our OS is Ubuntu Linux so we’ll be building .deb packages. We’ll be using S3 to store the packages. To avoid needing an AWS account when doing the tutorial, we provision a mock S3 server that mirror’s S3’s API. Lastly, to allow our destination machines to download the package, we’ll be passing them a presigned S3 download url which acts as temporary credentials and removes the need for an AWS SDK on the destination machine.</p>
<p>Side note: In a traditional data center, you might just install the AWS CLI tool on the destination host and either authorize that host’s IAM role to download from your S3 bucket, or pass a set of AWS credentials from Rundeck’s Key Storage to the AWS S3 client at download time. But maybe we have a less common setup, like an IoT deployment of low powered Raspberry Pi’s which would struggle to print the help text of the AWS CLI tool.</p>
<h2 id="building-the-package">Building the package</h2>
<p>First, we need to create a script to build the package. For convenience, let’s say we want to distribute the Hashicorp Consul binary.</p>
<p>First we need to download the binary we want to distribute:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="va">$!</span><span class="ex">/bin/bash</span> -xe</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># Change to a new temporary directory</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="bu">cd</span> <span class="va">$(</span><span class="fu">mktemp</span> -d<span class="va">)</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co"># Create the download url</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="va">NAME=</span>consul</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="va">VERSION=</span><span class="st">&quot;1.2.3&quot;</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="va">URL=</span><span class="st">&quot;https://releases.hashicorp.com/</span><span class="va">$NAME</span><span class="st">/3.0.x/</span><span class="va">$NAME_3</span><span class="st">.0.x_linux_amd64.zip&quot;</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co"># Download the url to the current directory</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="bu">echo</span> <span class="st">&quot;INFO - Downloading </span><span class="va">$URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="ex">curl</span> -sOL <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co"># Unzip the downloaded file. In this case we know it&#39;s a single file: the consul binary.</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="fu">unzip</span> <span class="va">$(</span><span class="fu">basename</span> <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span><span class="va">)</span></a></code></pre></div>
<p>Then we need to package the binary into a .deb format. We’ll use the very handy <a href="https://github.com/jordansissel/fpm">fpm</a> utility to abstract the gory details into a one-liner:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Call fpm with a directory as the source and a deb as the target. Name the package consul and give it the same version as what we downloaded.</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ex">fpm</span> -s dir -t deb --name <span class="st">&quot;</span><span class="va">$NAME</span><span class="st">&quot;</span> --version <span class="st">&quot;</span><span class="va">$VERSION</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$PKG_DIR</span><span class="st">&quot;</span></a></code></pre></div>
<p>We want the consul binary to be executable in the system’s executable path, so we create that directory structure before calling fpm:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="va">PKG_DIR=</span>usr</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="fu">mkdir</span> -p <span class="st">&quot;</span><span class="va">$PKG_DIR</span><span class="st">/bin&quot;</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="fu">install</span> ./consul <span class="st">&quot;</span><span class="va">$PKG_DIR</span><span class="st">/bin&quot;</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="ex">fpm</span> -s dir -t deb --name <span class="st">&quot;</span><span class="va">$NAME</span><span class="st">&quot;</span> --version <span class="st">&quot;</span><span class="va">$VERSION</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$PKG_DIR</span><span class="st">&quot;</span></a></code></pre></div>
<p>The full script so far looks like:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="va">$!</span><span class="ex">/bin/bash</span> -xe</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co"># Change to a new temporary directory</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="bu">cd</span> <span class="va">$(</span><span class="fu">mktemp</span> -d<span class="va">)</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># Create the download url</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="va">NAME=</span>consul</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="va">VERSION=</span><span class="st">&quot;1.2.3&quot;</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="va">URL=</span><span class="st">&quot;https://releases.hashicorp.com/</span><span class="va">$NAME</span><span class="st">/3.0.x/</span><span class="va">$NAME_3</span><span class="st">.0.x_linux_amd64.zip&quot;</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co"># Download the url to the current directory</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="bu">echo</span> <span class="st">&quot;INFO - Downloading </span><span class="va">$URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="ex">curl</span> -sOL <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co"># Unzip the downloaded file. In this case we know </span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="ex">it</span><span class="st">&#39;s a single file: the consul binary.</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="st">echo &quot;INFO - Packaging $NAME version $VERSION&quot;</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="st">unzip $(basename &quot;$URL&quot;)</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="st"># Create the appropriate directory structure</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="st">PKG_DIR=usr</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="st">mkdir -p &quot;$PKG_DIR/bin&quot;</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="st">install ./consul &quot;$PKG_DIR/bin&quot;</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="st"># Call fpm with a directory as the source and a deb as the target. Name the package consul and give it the same version as what we downloaded.</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="st">fpm -s dir -t deb --name &quot;$NAME&quot; --version &quot;$VERSION&quot; --deb-no-default-config-files &quot;$PKG_DIR&quot;</span></a></code></pre></div>
<p>If you run that you might get:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="ex">+</span> fpm -s dir -t deb --name consul --version 1.2.3 --deb-no-default-config-files usr</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="ex">Created</span> package <span class="dt">{:path=&gt;&quot;consul_1.2.3_amd64.deb&quot;}</span></a></code></pre></div>
<p>“Oh,” you might be thinking, “Maybe I should use the Key Value Data log filter to capture that path output to capture that outputed filename to pass to an upload script.”</p>
<p>You could do that, especially if you had a custom script plugin to do uploads. However for this tutorial, we’ll just do the uploading from the same script, so we’ll capture the outputted filename like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="va">DEB_FILE=$(</span><span class="ex">fpm</span> -s dir -t deb --name <span class="st">&quot;</span><span class="va">$NAME</span><span class="st">&quot;</span> --version <span class="st">&quot;</span><span class="va">$VERSION</span><span class="st">&quot;</span> --deb-no-default-config-files  <span class="st">&quot;</span><span class="va">$PKG_DIR</span><span class="st">&quot;</span> \</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">    <span class="kw">|</span> <span class="ex">ruby</span> -e <span class="st">&#39;puts eval(STDIN.read)[:path]&#39;</span><span class="va">)</span></a></code></pre></div>
<p>Here we’re piping the fpm output into a Ruby snippet to parse the map and print out the path key, which we capture in the DEB_FILE bash variable.</p>
<p>Now we upload the .deb file using the AWS CLI tool and a set of AWS credentials passed into the script:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="va">S3_URL=</span><span class="st">&quot;s3://rundeck-playground/consul/</span><span class="va">${DEB_FILE}</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="bu">echo</span> <span class="st">&quot;INFO - Uploading </span><span class="va">$DEB_FILE</span><span class="st"> to </span><span class="va">$S3_URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="bu">export</span> <span class="va">AWS_ACCESS_KEY_ID=$1</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw">set</span> <span class="ex">+x</span> <span class="co"># Don&#39;t log the secret key</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="bu">export</span> <span class="va">AWS_SECRET_ACCESS_KEY=$2</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">set</span> <span class="ex">-x</span> <span class="co"># Continue verbose bash logging</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="ex">aws</span> s3 cp --quiet <span class="st">&quot;</span><span class="va">$DEB_FILE</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$S3_URL</span><span class="st">&quot;</span></a></code></pre></div>
<p>In the Rundeck Playground environment, you don’t need to create the bucket beforehand because it’s a mock s3 server, but in the real AWS environment, you do.</p>
<p>Lastly, we want to generate a presigned url that we want Rundeck to pass to the destination nodes that will install the package. To do that:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="bu">echo</span> <span class="st">&quot;INFO - Generating presigned url for </span><span class="va">$S3_URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="va">DOWNLOAD_URL=$(</span><span class="ex">aws</span> s3 presign <span class="st">&quot;</span><span class="va">$S3_URL</span><span class="st">&quot;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="bu">echo</span> <span class="st">&quot;RUNDECK:DATA:DOWNLOAD_URL = </span><span class="va">$DOWNLOAD_URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="bu">echo</span> <span class="st">&quot;RUNDECK:DATA:DEB_FILE = </span><span class="va">$DEB_FILE</span><span class="st">&quot;</span></a></code></pre></div>
<p>The <code>aws s3 presign</code> command takes an S3 path that you have access to and creates a url that anyone can read from but expires in a fixed amount of time, in this case the default is 1 hour. It prints out the presigned url which we capture in the DOWNLOAD_URL bash variable.</p>
<p>Now, we print out the variables we want to use in subsequent Rundeck steps in a format that Rundeck can capture: <code>RUNDECK:DATA:$VARIABLE = $VALUE</code></p>
<p>The full build.sh script:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co">#!/bin/bash -xe</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="va">S3_BASE=</span>rundeck-playground/consul/</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="bu">cd</span> <span class="va">$(</span><span class="fu">mktemp</span> -d<span class="va">)</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="va">_pkgdir=</span><span class="st">&quot;pkg&quot;</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="va">NAME=</span>consul</a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="va">BIN_NAME=${BIN_NAME-$NAME}</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="va">VERSION=</span><span class="st">&quot;1.2.3&quot;</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="va">URL=</span><span class="st">&quot;https://releases.hashicorp.com/consul/3.0.x/consul_3.0.x_linux_amd64.zip&quot;</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="fu">mkdir</span> -p <span class="st">&quot;</span><span class="va">$_pkgdir</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="bu">echo</span> <span class="st">&quot;INFO - Downloading </span><span class="va">$URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="ex">curl</span> -sOL <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"></a>
<a class="sourceLine" id="cb9-19" data-line-number="19"><span class="bu">echo</span> <span class="st">&quot;INFO - Packaging </span><span class="va">$NAME</span><span class="st"> version </span><span class="va">$VERSION</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="fu">unzip</span> <span class="va">$(</span><span class="fu">basename</span> <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="fu">touch</span> <span class="va">$BIN_NAME</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="fu">mkdir</span> -p <span class="st">&quot;</span><span class="va">${_pkgdir}</span><span class="st">/usr/bin&quot;</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23"><span class="fu">install</span> <span class="st">&quot;</span><span class="va">$BIN_NAME</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">${_pkgdir}</span><span class="st">/usr/bin&quot;</span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24"><span class="bu">cd</span> <span class="va">${_pkgdir}</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25"><span class="va">DEB_FILE=$(</span><span class="ex">fpm</span> -s dir -t deb --name <span class="st">&quot;</span><span class="va">$NAME</span><span class="st">&quot;</span> --version <span class="st">&quot;</span><span class="va">$VERSION</span><span class="st">&quot;</span> . <span class="kw">|</span> <span class="ex">ruby</span> -e <span class="st">&#39;puts eval(STDIN.read)[:path]&#39;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26"></a>
<a class="sourceLine" id="cb9-27" data-line-number="27"><span class="va">S3_URL=</span><span class="st">&quot;s3://</span><span class="va">${S3_BASE%%</span>/*<span class="va">}</span><span class="st">/</span><span class="va">${DEB_FILE}</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28"><span class="bu">echo</span> <span class="st">&quot;INFO - Uploading </span><span class="va">$DEB_FILE</span><span class="st"> to </span><span class="va">$S3_URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-29" data-line-number="29"><span class="bu">export</span> <span class="va">AWS_ACCESS_KEY_ID=$1</span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30"><span class="kw">set</span> <span class="ex">+x</span></a>
<a class="sourceLine" id="cb9-31" data-line-number="31"><span class="bu">export</span> <span class="va">AWS_SECRET_ACCESS_KEY=$2</span></a>
<a class="sourceLine" id="cb9-32" data-line-number="32"><span class="kw">set</span> <span class="ex">-x</span></a>
<a class="sourceLine" id="cb9-33" data-line-number="33"><span class="ex">aws</span> s3 cp --quiet <span class="st">&quot;</span><span class="va">$DEB_FILE</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$S3_URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-34" data-line-number="34"></a>
<a class="sourceLine" id="cb9-35" data-line-number="35"><span class="bu">echo</span> <span class="st">&quot;INFO - Generating presigned url for </span><span class="va">$S3_URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-36" data-line-number="36"><span class="bu">echo</span> -n <span class="st">&quot;RUNDECK:DATA:DOWNLOAD_URL = &quot;</span></a>
<a class="sourceLine" id="cb9-37" data-line-number="37"><span class="ex">aws</span> s3 presign <span class="st">&quot;</span><span class="va">$S3_URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb9-38" data-line-number="38"><span class="bu">echo</span> <span class="st">&quot;RUNDECK:DATA:DEB_FILE = </span><span class="va">$DEB_FILE</span><span class="st">&quot;</span></a></code></pre></div>
<h2 id="wrap-the-build-script-in-a-custom-script-step-plugin">Wrap the build script in a custom script step plugin</h2>
<p>To trigger build script we just created, we could use a Rundeck script step. However, since the script needs credentials, it’s better practice to wrap the script in a custom script step plugin so that you can securely pass secrets from Key Storage into the script.</p>
<p>The build script’s plugin.yaml would look like:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="fu">name:</span><span class="at"> deb builder</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="fu">version:</span><span class="at"> 1</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="fu">rundeckPluginVersion:</span><span class="at"> 1.2</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="fu">author:</span><span class="at"> Carlo Cabanilla</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="fu">date:</span><span class="at"> 2018-09-21</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="fu">url:</span><span class="at"> http://rundeck.org/</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="fu">providers:</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> BuildDeb</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">    <span class="fu">script-interpreter:</span><span class="at"> /bin/bash -xe</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">    <span class="fu">script-file:</span><span class="at"> build.sh</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">    <span class="fu">script-args:</span><span class="at"> ${config.aws_access_key_id} ${config.aws_secret_access_key}</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">      <span class="kw">-</span> <span class="fu">name:</span><span class="at"> aws_access_key_id</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">        <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">      <span class="kw">-</span> <span class="fu">name:</span><span class="at"> aws_secret_access_key</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">        <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a></code></pre></div>
<p>Note the <code>renderingOptions:valueConversion: &quot;STORAGE_PATH_AUTOMATIC_READ&quot;</code> settings on the credential values. That lets us pass in Key Storage paths and the plugin will pull the values and pass it into the script. For a more detailed tutorial on custom script step plugins, see <a href="custom-script-plugin---hello-world.html" title="Tutorials - Custom Script Plugin - Hello World">Custom Script Plugin - Hello World</a>.</p>
<h2 id="create-the-job">Create the job</h2>
<p>Now we need a job to trigger the script step. It might look like this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">-</span> <span class="fu">uuid:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="fu">name:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> fpm</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">    <span class="kw">-</span> <span class="fu">type:</span><span class="at"> BuildDeb</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">      <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10">        <span class="fu">aws_access_key_id:</span><span class="at"> keys/projects/hello-project/aws/access-key-id</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">        <span class="fu">aws_secret_access_key:</span><span class="at"> keys/projects/hello-project/aws/secret-access-key</span></a></code></pre></div>
<p>The new config here are the Key Storage paths to the AWS credentials and the nodefilter to select the node to run the build.</p>
<h2 id="highlighting-high-level-log-output">Highlighting high level log output</h2>
<p>If we test it out in the web UI, the output might look like:</p>
<figure>
<img src="../figures/log-highlight-none.png" alt="Without highlighting" /><figcaption>Without highlighting</figcaption>
</figure>
<p>Here we can apply our first log filter to call out our high level logging output so that it stands out from the low level script commands.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">-</span> <span class="fu">uuid:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  <span class="fu">name:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> fpm</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">    <span class="fu">pluginConfig:</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">      <span class="fu">LogFilter:</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> highlight-output</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">        <span class="fu">config:</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">          <span class="fu">bgcolor:</span><span class="at"> yellow</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11">          <span class="fu">mode:</span><span class="at"> bold</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12">          <span class="fu">regex:</span><span class="at"> ^INFO\s*-\s*(.*)$</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">    <span class="kw">-</span> <span class="fu">type:</span><span class="at"> BuildDeb</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15">      <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17">        <span class="fu">aws_access_key_id:</span><span class="at"> keys/projects/hello-project/aws/access-key-id</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18">        <span class="fu">aws_secret_access_key:</span><span class="at"> keys/projects/hello-project/aws/secret-access-key</span></a></code></pre></div>
<figure>
<img src="../figures/log-highlight-bold.png" alt="With highlighting" /><figcaption>With highlighting</figcaption>
</figure>
<p>Now we can more easily skim the log output for the important steps.</p>
<h2 id="prevent-accidental-leakage-of-secrets">Prevent accidental leakage of secrets</h2>
<p>Remember this snippet of our build script?</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">set</span> <span class="ex">+x</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="bu">export</span> <span class="va">AWS_SECRET_ACCESS_KEY=$2</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw">set</span> <span class="ex">-x</span></a></code></pre></div>
<p>Since we’re running the script with <code>bash -x</code>, it prints out each command that it’s running and the values of the variables we assign. The above snippet explictly suppresses that verbose logging when we set the secret key to avoid exposing it in the logs.</p>
<p>What if we didn’t have the foresight to supress that output? Could we prevent ourselves from shooting ourselves in the foot?</p>
<p>We can partially protect ourselves using the <code>quiet-output</code> log filter:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb14-1" data-line-number="1">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">    <span class="fu">pluginConfig:</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">      <span class="fu">LogFilter:</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> quiet-output</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">        <span class="fu">config:</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">          <span class="fu">loglevel:</span><span class="at"> debug</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">          <span class="fu">matchLoglevel:</span><span class="at"> all</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">          <span class="fu">quietMatch:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">          <span class="fu">regex:</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></a></code></pre></div>
<p>Here we’re saying at any log level, if you see the string <code>AWS_SECRET_ACCESS_KEY</code>, change that log line’s log level to debug. This would have prevented us leaking the the key from <code>bash -x</code> output, assuming we were running under the default log level. However, the filter wouldn’t hide it if you ran it with the debug log level.</p>
<p>Additionally, it won’t prevent something like:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="bu">echo</span> <span class="va">$AWS_SECRET_ACCESS_KEY</span></a></code></pre></div>
<p>Because <code>bash -x</code> logging would have evaluated the variable already and it will show up as:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="ex">+</span> echo whatever_the_value_is</a></code></pre></div>
<p>So while the <code>quiet-output</code> shouldn’t be your main protection from hiding secrets, it’s another possible safeguard and better than nothing.</p>
<h2 id="running-jobs-on-different-sets-of-nodes">Running jobs on different sets of nodes</h2>
<p>We want to install the package on different nodes than we built it on, but there’s no way to specify a different set of nodes for different steps, so how can we proceed?</p>
<p>We can create another job to install the package and reference the build job to trigger the build. Here is the new job:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> InstallDeb</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3">    <span class="fu">filter:</span><span class="at"> web_.*</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">        <span class="fu">uuid:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8">    <span class="kw">-</span> <span class="fu">script:</span><span class="at"> |</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9">        <span class="co">#!/bin/bash -xe</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10">        WORKING_DIR=$(mktemp -d)</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">        echo <span class="st">&quot;INFO - Downloading $2 to $WORKING_DIR&quot;</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12">        cd $WORKING_DIR</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">        curl -sL <span class="st">&quot;$1&quot;</span> &gt; $2</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">        echo <span class="st">&quot;INFO - Installing $2&quot;</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15">        dpkg -i <span class="st">&quot;$2&quot;</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16">        rm <span class="st">&quot;$2&quot;</span></a></code></pre></div>
<p>The new node filter points to the web nodes, our destination for the package.</p>
<p><code>jobref</code> lets us call other jobs and let them use their own node filter. In this case we call PackageDeb to package the deb on the fpm node.</p>
<p>The second step is an inline script to download and install the package. We don’t need to wrap it in a custom script step plugin because there’s no credentials to deal with.</p>
<h2 id="passing-data-from-one-job-to-another">Passing data from one job to another</h2>
<p>But wait, how does this job know what the download url and the name of the package file are? At last, this is where the key value log filter comes into play:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> InstallDeb</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">    <span class="fu">filter:</span><span class="at"> web_.*</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5">    <span class="fu">pluginConfig:</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6">      <span class="fu">LogFilter:</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> key-value-data</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">        <span class="fu">config:</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9">          <span class="fu">logData:</span><span class="at"> </span><span class="st">&#39;false&#39;</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10">          <span class="fu">regex:</span><span class="at"> ^RUNDECK:DATA:(.+?)\s*=\s*(.+)$</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13">        <span class="fu">uuid:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb18-14" data-line-number="14">    <span class="kw">-</span> <span class="fu">args:</span><span class="at"> ${data.DOWNLOAD_URL} ${data.DEB_FILE}</span></a>
<a class="sourceLine" id="cb18-15" data-line-number="15">      <span class="fu">script:</span><span class="at"> |</span></a>
<a class="sourceLine" id="cb18-16" data-line-number="16">        <span class="co">#!/bin/bash -xe</span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17">        WORKING_DIR=$(mktemp -d)</a>
<a class="sourceLine" id="cb18-18" data-line-number="18">        echo <span class="st">&quot;INFO - Downloading $2 to $WORKING_DIR&quot;</span></a>
<a class="sourceLine" id="cb18-19" data-line-number="19">        cd $WORKING_DIR</a>
<a class="sourceLine" id="cb18-20" data-line-number="20">        curl -sL <span class="st">&quot;$1&quot;</span> &gt; $2</a>
<a class="sourceLine" id="cb18-21" data-line-number="21">        echo <span class="st">&quot;INFO - Installing $2&quot;</span></a>
<a class="sourceLine" id="cb18-22" data-line-number="22">        dpkg -i <span class="st">&quot;$2&quot;</span></a>
<a class="sourceLine" id="cb18-23" data-line-number="23">        rm <span class="st">&quot;$2&quot;</span></a></code></pre></div>
<p>Here we define a regex to capture that simple format we used in the build script. The variables get stored in the <code>data</code> context where we can refer to them later on in the job.</p>
<p>However! If the InstallDeb’s own log output printed out <code>RUNDECK:DATA:DOWNLOAD_URL = ...</code> then this would work, but the above configuration won’t work because the parent job doesn’t have access to the job reference’s data.</p>
<p>Instead, we need to export the variables from the build job so that the install job has access to them. Modifying the PackageDeb job:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw">-</span> <span class="fu">uuid:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  <span class="fu">name:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> fpm</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">    <span class="fu">pluginConfig:</span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7">      <span class="fu">LogFilter:</span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> key-value-data</span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9">        <span class="fu">config:</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10">          <span class="fu">logData:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11">          <span class="fu">regex:</span><span class="at"> ^RUNDECK:DATA:(.+?)\s*=\s*(.+)$</span></a>
<a class="sourceLine" id="cb19-12" data-line-number="12">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb19-13" data-line-number="13">    <span class="kw">-</span> <span class="fu">type:</span><span class="at"> BuildDeb</span></a>
<a class="sourceLine" id="cb19-14" data-line-number="14">      <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb19-15" data-line-number="15">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb19-16" data-line-number="16">        <span class="fu">aws_access_key_id:</span><span class="at"> keys/projects/hello-project/aws/access-key-id</span></a>
<a class="sourceLine" id="cb19-17" data-line-number="17">        <span class="fu">aws_secret_access_key:</span><span class="at"> keys/projects/hello-project/aws/secret-access-key</span></a>
<a class="sourceLine" id="cb19-18" data-line-number="18">    <span class="kw">-</span> <span class="fu">type:</span><span class="at"> export-var</span></a>
<a class="sourceLine" id="cb19-19" data-line-number="19">      <span class="fu">nodeStep:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb19-20" data-line-number="20">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb19-21" data-line-number="21">        <span class="fu">export:</span><span class="at"> DOWNLOAD_URL</span></a>
<a class="sourceLine" id="cb19-22" data-line-number="22">        <span class="fu">group:</span><span class="at"> export</span></a>
<a class="sourceLine" id="cb19-23" data-line-number="23">        <span class="fu">value:</span><span class="at"> ${data.DOWNLOAD_URL@fpm}</span></a>
<a class="sourceLine" id="cb19-24" data-line-number="24">    <span class="kw">-</span> <span class="fu">type:</span><span class="at"> export-var</span></a>
<a class="sourceLine" id="cb19-25" data-line-number="25">      <span class="fu">nodeStep:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb19-26" data-line-number="26">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb19-27" data-line-number="27">        <span class="fu">export:</span><span class="at"> DEB_FILE</span></a>
<a class="sourceLine" id="cb19-28" data-line-number="28">        <span class="fu">group:</span><span class="at"> export</span></a>
<a class="sourceLine" id="cb19-29" data-line-number="29">        <span class="fu">value:</span><span class="at"> ${data.DEB_FILE@fpm}</span></a></code></pre></div>
<p>The key here is the <code>export-var</code> steps to move the <code>data.DOWNLOAD_URL</code> and <code>data.DEB_FILE</code> values captured with the <code>key-value-data</code> log filter into the <code>export</code> global variable group.</p>
<p>Now our InstallDeb job can use those global variables:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> InstallDeb</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3">    <span class="fu">filter:</span><span class="at"> web_.*</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7">        <span class="fu">uuid:</span><span class="at"> PackageDeb</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8">    <span class="kw">-</span> <span class="fu">args:</span><span class="at"> ${export.DOWNLOAD_URL} ${export.DEB_FILE}</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9">      <span class="fu">script:</span><span class="at"> |</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10">        <span class="co">#!/bin/bash -xe</span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11">        WORKING_DIR=$(mktemp -d)</a>
<a class="sourceLine" id="cb20-12" data-line-number="12">        echo <span class="st">&quot;INFO - Downloading $2 to $WORKING_DIR&quot;</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13">        cd $WORKING_DIR</a>
<a class="sourceLine" id="cb20-14" data-line-number="14">        curl -sL <span class="st">&quot;$1&quot;</span> &gt; $2</a>
<a class="sourceLine" id="cb20-15" data-line-number="15">        echo <span class="st">&quot;INFO - Installing $2&quot;</span></a>
<a class="sourceLine" id="cb20-16" data-line-number="16">        dpkg -i <span class="st">&quot;$2&quot;</span></a>
<a class="sourceLine" id="cb20-17" data-line-number="17">        rm <span class="st">&quot;$2&quot;</span></a></code></pre></div>
<p>And now the web nodes have the presigned url generated by the fpm node. Magic!</p>
<p>To recap, running this job would:</p>
<ul>
<li>Run a script on a build node to package a binary into a deb and securely upload it to S3.</li>
<li>Pass a temporary url from the build node to let a different set of nodes without AWS credentials or a special S3 client download and install the package.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="container bottom breadcrumb_holder">
<div class="row">
<div class="col-sm-6" id="#breadcrumbsbottom">

<div class="navquerytoggle collapse" aria-expanded="false">
<div class="input-group ">
    <a class="input-group-addon btn btn-xs" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbsbottom"><i class="glyphicon glyphicon-search"></i></a>
    <input type="text" class="form-control navquery  " name="q" placeholder="Search" autofocus="true">    
    <a class="input-group-addon btn btn-xs" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbsbottom"><i class="glyphicon glyphicon-remove"></i></a>
</div>
</div>

<ol class="breadcrumb bottom collapse in navquerytoggle" aria-expanded="true">
    <li class="navquerytrigger collapse" title="Find a page by name. (Keyboard shortcut: q)" data-toggle="tooltip" data-container="body">
        <a class="btn btn-xs btn-link" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbsbottom">
            <i class="glyphicon glyphicon-search"></i>
        </a>
    </li>

    
        <li><a href="../index.html">Rundeck Documentation (3.0.x)</a></li>
    
    
    <li ><a href="index.html">Tutorials</a></li>
    <li class="active"><a href="log-filters.html">Log Filters</a></li>
</ol>
</div>
<div class="col-sm-6">
    <ul class="pager">
      <li class="previous"><a href="custom-script-plugin---db-credential-rotation.html"><i class="glyphicon glyphicon-arrow-left"></i> Custom Script Plugin - DB Credential Rotation</a></li>
      <li class="next"><a href="java-plugin.html">Java Plugin <i class="glyphicon glyphicon-arrow-right"></i></a></li>
    </ul>
</div>
</div>
<div class="row">
<div class="col-sm-12 text-right">
    <a class="btn btn-link bottom" href="https://github.com/rundeck/docs/issues/new?labels=bug&title=Documentation+bug+in+file+tutorials/log-filters.md&template=documentation-bug.md"><i class="glyphicon glyphicon-flag"></i> Report a problem</a>
    <a class="btn btn-link bottom btn-edit-this-page" href="https://github.com/rundeck/docs/edit/3.0.x/en/tutorials/log-filters.md"><i class="glyphicon glyphicon-pencil"></i>  Edit this page</a>
</div>
</div>
</div>
<div class='container footer'>

<div class="row">
	<footer class="copy col-sm-12 text-muted">

<p>
<a class="btn btn-info btn-try-rundeck-pro" href="http://rundeck.com/" data-toggle="popover" data-trigger="hover" 
data-content="<ul class=&quot;list-unstyled&quot;>
	<li><i class=&quot;glyphicon glyphicon-gift&quot;></i> Try Rundeck Enterprise for Free</li>
	<li><i class=&quot;glyphicon glyphicon-flash&quot;></i> Get Exclusive Features</li>
	<li><i class=&quot;glyphicon glyphicon-briefcase&quot;></i> Get Professional Support</li>
	<li><i class=&quot;glyphicon glyphicon-heart&quot;></i> Support Open-source Development</li>
	<li><i class=&quot;glyphicon glyphicon-thumbs-up&quot;></i> Get home by 5 </li>
</ul>" data-html="true">
<i class="glyphicon glyphicon-hand-right"></i>
Try Rundeck Enterprise
</a>
</p>

<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Rundeck Documentation</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://rundeck.com" property="cc:attributionName" rel="cc:attributionURL">Rundeck, Inc</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
<p>
&copy;2019 <a href="http://rundeck.com">Rundeck</a>
</p>
<p>
<span class="generated-date" title="2019-04-19T21:46:12UTC">2019-04-19T21:46:12UTC</span>
</p>
</footer>
</div>
</div>
<script type="text/javascript">
  

   var _gaq = [['_setAccount', 'UA-529275-13'], ['_trackPageview']];
   (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
   })(document, 'script');
  </script>

<script>window.markdeepOptions={mode:'html'};</script>
<!-- Markdeep: --><script src="../markdeep.min.js"></script>
<!-- <script src="https://casual-effects.com/markdeep/latest/markdeep.min.js"></script> -->

<!-- Start of HubSpot Embed Code -->
<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/2768099.js"></script>
<!-- End of HubSpot Embed Code -->
</body>
</html>
