<!DOCTYPE html>
<html>
<head>
  <title>Use case: database credential rotation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="generator" content="pandoc" />
<link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700,700i" rel="stylesheet">
<script>
window._pageRelpath="../";
</script>
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script
src="https://code.jquery.com/jquery-2.2.4.min.js"
integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
crossorigin="anonymous"></script>
<script
src="https://code.jquery.com/ui/1.11.3/jquery-ui.min.js"
integrity="sha256-xI/qyl9vpwWFOXz7+x/9WkG5j/SVnSw21viy8fWwbeE="
crossorigin="anonymous"></script>
<script src="../jquery.autocomplete.min.js"></script>
<script src="../docs-autocomplete.js"></script>
<!-- Latest compiled and minified JavaScript -->
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../styles.css" type="text/css" />
</head>
<body data-spy="scroll" data-target=".toc-nav" class="navbar-is-fixed-top">
<nav role="navigation" aria-label="main navigation" class="navbar is-fixed-top">
  <div class="container">
    <div class="navbar-brand"><a href="https://www.rundeck.com/open-source" class="navbar-item logo"><span
          data-v-ddc5174c=""><svg width="159" height="23" viewBox="0 0 159 23" xmlns="http://www.w3.org/2000/svg"
            class="logo-image" data-v-ddc5174c="">
            <g class="logo-type" fill="none" fill-rule="evenodd" data-v-ddc5174c="">
              <path
                d="M36.133 10.399v-6.26h1.073c2.78 0 4.17 1.01 4.17 3.028 0 2.155-1.43 3.232-4.285 3.232h-.959zm6.963.332c.813-1.005 1.219-2.206 1.219-3.603 0-1.788-.648-3.227-1.942-4.317-1.174-.98-3.081-1.47-5.722-1.47h-3.535v19.725h3.017v-8.074h.542l5.71 8.074h3.69l-6.189-8.407c1.33-.28 2.4-.923 3.21-1.928zM60.561 13.222c0 1.72-.28 2.96-.842 3.716-.836 1.134-2.02 1.7-3.547 1.7-1.52 0-2.697-.566-3.534-1.7-.56-.783-.84-2.021-.84-3.716V1.341H48.78V14.04c0 2.077.656 3.789 1.968 5.135 1.467 1.499 3.276 2.247 5.424 2.247 2.15 0 3.961-.748 5.438-2.247 1.312-1.346 1.967-3.058 1.967-5.135V1.341h-3.016v11.881zM82.944 15.048L68.367 0v21.065h3.016V7.256l14.577 15.01V1.341h-3.016zM100.938 16.428a6.872 6.872 0 0 1-2.434 1.418c-.897.282-2.024.422-3.379.422h-1.359V4.138h1.36c2.571 0 4.518.602 5.838 1.802 1.468 1.346 2.201 3.1 2.201 5.264 0 2.146-.742 3.887-2.227 5.224m2.175-12.544c-1.019-.92-2.153-1.571-3.404-1.955-1.166-.392-2.753-.588-4.764-.588H90.75v19.724h4.142c2.028 0 3.595-.183 4.7-.55 1.182-.365 2.312-1.017 3.391-1.954 2.15-1.873 3.224-4.325 3.224-7.357 0-3.024-1.03-5.463-3.094-7.32M110.001 21.065h11.03v-2.797h-8.014v-6.592h7.78V8.878h-7.78V4.14h8.014V1.341h-11.03zM126.52 4.574c-1.684 1.966-2.526 4.206-2.526 6.72 0 2.8 1.006 5.194 3.017 7.177 2.02 1.968 4.458 2.951 7.314 2.951 1.9 0 3.711-.48 5.437-1.442v-3.59c-.49.409-.96.758-1.404 1.047-.445.29-.873.52-1.288.69-.743.34-1.644.512-2.706.512-2.054 0-3.789-.712-5.205-2.133-1.415-1.424-2.122-3.17-2.122-5.24 0-2.094.707-3.864 2.122-5.313 1.407-1.457 3.138-2.184 5.192-2.184 1.865 0 3.668.72 5.411 2.159V2.402c-1.674-.963-3.408-1.444-5.204-1.444-3.288 0-5.967 1.205-8.039 3.615M149.912 10.27l9.037-8.928h-4.027l-7.78 7.869V1.34h-3.016v19.724h3.016v-8.163l.62-.613 7.199 8.776H159z"
                fill="#000" data-v-ddc5174c=""></path>
              <g class="logo-arrow" fill="#F7403A" data-v-ddc5174c="">
                <path
                  d="M0 21.065h13.404l2.501-3.945H2.501zM15.905 5.286L13.404 1.34H0l2.501 3.945zM18.406 9.23H5.002l1.25 1.973-1.25 1.973h13.404l1.25-1.973z"
                  data-v-ddc5174c=""></path>
              </g>
            </g>
          </svg></span></a> <a role="button" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample"
        class="navbar-burger burger"><span aria-hidden="true"></span> <span aria-hidden="true"></span> <span
          aria-hidden="true"></span></a></div>
    <div class="navbar-menu">
      <div class="navbar-start">
      </div>
      <div class="navbar-end">
        <div class="navbar-item">
        <form role="search"  action="/search/">
          <div class="field has-addons">
            <div class="control">
              <input type="text" class="input form-control navquery" name="q" placeholder="Search" id="searchQuery" autocomplete="off">
            </div>
            <div class="control">
              <button type="submit" class="button red-button">
                Search
              </button>
            </div>
          </div>
        </form>
        </div>
      </div>
    </div>
  </div>
</nav>
<div class="container">
    <nav class="breadcrumb" aria-label="breadcrumbs">
        <div class="columns">
            <div class="column is-two-thirds">
            <ul>
                
                    
                        <li><a href="../index.html">Rundeck Documentation (3.1.0)</a></li>
                    
                
                <li ><a href="index.html">Tutorials</a></li>
                <li class="active"><a href="custom-script-plugin---db-credential-rotation.html">Custom Script Plugin - DB Credential Rotation</a></li>
            </ul>
            </div>
            <div class="column">
            <ul>
                <li class="previous"><a href="custom-script-plugin---hello-world.html"><i class="fas fa-arrow-left"></i>Custom Script Plugin - Hello World</a></li>
                <li class="next"><a href="log-filters.html">Log Filters <i class="fas fa-arrow-right"></i></a></li>
            </ul>
            </div>
        </div>
    </nav>
    <div class="breadcrumb-footer">
        <a class="btn btn-link top" href="https://github.com/rundeck/docs/issues/new?labels=bug&title=Documentation+bug+in+file+tutorials/custom-script-plugin-db-cred-rotation.md&template=documentation-bug.md"> <i class="fas fa-flag"></i> Report a problem </a>
        <a class="btn btn-link top btn-edit-this-page" href="https://github.com/rundeck/docs/edit/3.0.x/en/tutorials/custom-script-plugin-db-cred-rotation.md"><i class="fas fa-pencil-alt"></i> Edit this page</a>
    </div>
</div>
<div id="docbody">
<div class="container">
<div class="columns">
<div class="column is-one-quarter toc-nav">
<section class="section sticky-toc">
<div class="nav">
<ul>
<li><a href="#the-problem">The problem</a></li>
<li><a href="#addressing-the-problem-with-rundeck">Addressing the problem with Rundeck</a><ul>
<li><a href="#secure-secrets-handling">Secure secrets handling</a></li>
<li><a href="#critical-logic-is-tested-ahead-of-time">Critical logic is tested ahead of time</a></li>
<li><a href="#ease-of-use-encourages-proactive-security">Ease of use encourages proactive security</a></li>
</ul></li>
<li><a href="#automating-credential-rotation-with-rundeck">Automating credential rotation with Rundeck</a><ul>
<li><a href="#restarting-the-apps">Restarting the apps</a></li>
<li><a href="#modifying-the-app-config">Modifying the app config</a></li>
<li><a href="#creating-the-new-db-login">Creating the new db login</a></li>
<li><a href="#deleting-the-old-db-login">Deleting the old db login</a></li>
<li><a href="#tying-it-all-together">Tying it all together</a></li>
</ul></li>
</ul>
</div>
</div>
</section>
<div class="column">
<section class="section content">
<div class="page-header">
<h1 class="title">Use case: database credential rotation</h1>
</div>
<p>Now that we know how to create custom workflow step script plugin in the <a href="custom-script-plugin---hello-world.html" title="Tutorials - Custom Script Plugin - Hello World">hello world tutorial</a>, let’s walk through a real world use case: rotation database credentials. Credential rotation has traditionally been a complicated, thankless administrative chore. It’s the type of work that might be labeled <a href="https://landing.google.com/sre/book/chapters/eliminating-toil.html">toil</a> and exactly the kind of work that Rundeck has been designed to streamline.</p>
<p>The end result of this tutorial as well as a Docker environment to run it in can be found on <a href="https://github.com/clofresh/rundeck-playground">GitHub</a></p>
<h2 id="the-problem">The problem</h2>
<p>What’s difficult about database credential rotation?</p>
<ul>
<li>It involves multiple steps across multiple nodes in your production cluster.</li>
<li>It’s necessary to handle secrets in the form of the new credentials you’re creating, plus credentials of a super user that can create the new login.</li>
<li>Manually run steps are error prone and mistakes can potentially cause a site-wide outage if your app can’t authenticate with the database anymore.</li>
</ul>
<h2 id="addressing-the-problem-with-rundeck">Addressing the problem with Rundeck</h2>
<p>By creating a custom script plugin to interact with the database, its downstream clients and the Rundeck Key Storage, we can automate the creation and deployment of the new credentials as well as safely handle the decomissioning of the old credentials.</p>
<h3 id="secure-secrets-handling">Secure secrets handling</h3>
<p>Since the Key Storage stores the credentials, the administrator triggering the credential rotation doesn’t ever need to see the actual credentials of the database super user or the newly generated database user.</p>
<h3 id="critical-logic-is-tested-ahead-of-time">Critical logic is tested ahead of time</h3>
<p>The logic for creating the database login is encapsulated in a script that has been tested prior to actually needing to rotate the credentials, so we avoid putting a human in the stressful, error-prone situation of having to figure out correct syntax to run on a live system on the fly.</p>
<p>Similarly, the app restart logic is encapsulated as well, with health check logic as an extra safety measure to halt the process in case something has gone wrong before applying the change to the whole cluster.</p>
<h3 id="ease-of-use-encourages-proactive-security">Ease of use encourages proactive security</h3>
<p>Lastly, by creating a single button solution to rotate database credentials, we’re much more likely to rotate our credentials on a regular basis to mitigate potential security risks, rather than only after a security incident has already occured.</p>
<h2 id="automating-credential-rotation-with-rundeck">Automating credential rotation with Rundeck</h2>
<p>In order to automate the credential rotation, we need to automate the individual steps, then orchestrate the steps in a single process. The steps we want to automate are:</p>
<ul>
<li>Creating a new database login</li>
<li>Updating the application configuration to use the new database login</li>
<li>Restarting the applications to apply the configuration change</li>
<li>Deleting the old database login</li>
</ul>
<h3 id="restarting-the-apps">Restarting the apps</h3>
<p>We can start with restarting the applications because that’s something we can test on its own before proceeding. We’ll create a new plugin metadata file <code>rundeck-plugins/db-creds/plugin.yaml</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">name:</span><span class="at"> Database credential management</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">version:</span><span class="at"> 1</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="fu">rundeckPluginVersion:</span><span class="at"> 1.2</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="fu">author:</span><span class="at"> Carlo Cabanilla</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="fu">date:</span><span class="at"> 2018-07-20</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="fu">url:</span><span class="at"> http://rundeck.org/</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="fu">providers:</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    <span class="fu">script-interpreter:</span><span class="at"> /bin/bash</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    <span class="fu">script-file:</span><span class="at"> restart.sh</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">    <span class="fu">script-args:</span><span class="at"> ${config.process} ${config.health_url}</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">        <span class="fu">name:</span><span class="at"> process</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">        <span class="fu">title:</span><span class="at"> process</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">        <span class="fu">description:</span><span class="at"> the process to restart</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">        <span class="fu">name:</span><span class="at"> health_url</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">        <span class="fu">title:</span><span class="at"> health_url</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">        <span class="fu">description:</span><span class="at"> the http endpoint to poll to check that it&#39;s healthy</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">        <span class="fu">default:</span><span class="at"> http://localhost:8080</span></a></code></pre></div>
<p>Our restart script takes 2 parameters: the name of the process on the node, and a url that we can poll to check that it’s healthy. The implementation of the restart script is specific to the Docker playground environment so we’ll leave out the details, but from a high level it:</p>
<ul>
<li>Kills the process and lets the supervising parent process restart it</li>
<li>Polls the health check url until it returns healthy or times out</li>
<li>Exits with an error code if it times out to let the calling process know whether to continue or not with downstream steps</li>
</ul>
<p>In order to be able to run the restart, we create a job that specifies the nodes to run it on and the input parameters. <code>rundeck-project/jobs/RestartApp.yaml</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> web_.*</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    <span class="kw">-</span> <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">        <span class="fu">health_url:</span><span class="at"> http://localhost:8080</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">        <span class="fu">process:</span><span class="at"> python3</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">      <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">      <span class="fu">type:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    <span class="fu">keepgoing:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    <span class="fu">strategy:</span><span class="at"> node-first</span></a></code></pre></div>
<p>We specify a <code>uuid</code> here so that we know how to refer to it from other jobs, otherwise Rundeck will assign a random uuid.</p>
<p>We can test the restart using our <a href="https://github.com/clofresh/rundeck-playground">playground Docker environment</a>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=RestartApp</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># Found matching job: RestartApp RestartApp</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co"># Execution started: [5] RestartApp /RestartApp &lt;http://127.0.0.1:4440/project/hello-project/execution/show/5&gt;</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="ex">Restarting</span> python3 app</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="ex">Waiting</span> for app to stop</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="ex">Waiting</span> for app to start and return 200</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="ex">Restarting</span> python3 app</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="ex">Waiting</span> for app to stop</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="ex">Waiting</span> for app to start and return 200</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="ex">Done</span></a></code></pre></div>
<h3 id="modifying-the-app-config">Modifying the app config</h3>
<p>Now we can create a step to update the configured database login on the application nodes. In your production environment you might use a configuration management tool like Ansible or Chef to accomplish this but here we use a simple Python script. We can add this to the <code>providers</code> key of <code>rundeck-plugins/db-creds/plugin.yaml</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb4-1" data-line-number="1">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> UpdateDBCredentials</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    <span class="fu">script-interpreter:</span><span class="at"> /usr/local/bin/python3</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">    <span class="fu">script-file:</span><span class="at"> change_password.py</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="fu">script-args:</span><span class="at"> /etc/web.yaml ${config.user} ${config.password}</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">        <span class="fu">name:</span><span class="at"> user</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">        <span class="fu">title:</span><span class="at"> user</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;db user&#39;</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">        <span class="fu">name:</span><span class="at"> password</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">        <span class="fu">title:</span><span class="at"> password</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;db password&#39;</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a></code></pre></div>
<p>Note the <code>valueConversion: &quot;STORAGE_PATH_AUTOMATIC_READ&quot;</code> setting to able to refer to a path in Key Storage for the database password.</p>
<p>Corresponding job config <code>rundeck-project/jobs/UpdateAppConfig.yaml</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> UpdateAppConfig</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> UpdateAppConfig</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> web_.*</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="fu">options:</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Database user</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    <span class="fu">name:</span><span class="at"> dbuser</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  <span class="fu">scheduleEnabled:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    <span class="kw">-</span> <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14">        <span class="fu">user:</span><span class="at"> ${option.dbuser}</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">        <span class="fu">password:</span><span class="at"> keys/projects/hello-project/db/${option.dbuser}</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16">      <span class="fu">type:</span><span class="at"> UpdateDBCredentials</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17">    <span class="fu">keepgoing:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18">    <span class="fu">strategy:</span><span class="at"> node-first</span></a></code></pre></div>
<p>In the job, we expose an option to the job user to specify the database user to set the config to. We use that value as part of the Key Storage path to look up the password. By using a naming convention for the key path, we hide the details of the Key Storage setup from the job user.</p>
<p>We can test it with:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=UpdateAppConfig JOB_OPTIONS=<span class="st">&#39;-dbuser web2&#39;</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co"># Found matching job: UpdateAppConfig UpdateAppConfig</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co"># Execution started: [6] UpdateAppConfig /UpdateAppConfig &lt;http://127.0.0.1:4440/project/hello-project/execution/show/6&gt;</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="ex">Updating</span> /etc/web.yaml with db user credentials: web2</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="ex">Updating</span> /etc/web.yaml with db user credentials: web2</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="ex">Done</span></a></code></pre></div>
<h3 id="creating-the-new-db-login">Creating the new db login</h3>
<p>Creating a new database login requires a super user database login plus a user and password for the new login. Add this to the <code>providers</code> key of <code>rundeck-plugins/db-creds/plugin.yaml</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb7-1" data-line-number="1">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> CreateDBUser</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    <span class="fu">script-interpreter:</span><span class="at"> /bin/bash</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    <span class="fu">script-file:</span><span class="at"> create-db-user.sh</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    <span class="fu">script-args:</span><span class="at"> ${config.master_db_user} ${config.master_db_password} ${config.new_user} ${config.new_password} ${config.role}</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">        <span class="fu">name:</span><span class="at"> master_db_user</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">        <span class="fu">title:</span><span class="at"> master_db_user</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;master db user&#39;</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">        <span class="fu">default:</span><span class="at"> master1</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">        <span class="fu">name:</span><span class="at"> master_db_password</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">        <span class="fu">title:</span><span class="at"> master_db_password</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;master db user password&#39;</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17">        <span class="fu">default:</span><span class="at"> keys/projects/hello-project/db/master1</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21">        <span class="fu">name:</span><span class="at"> new_user</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22">        <span class="fu">title:</span><span class="at"> new_user</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;New db user&#39;</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">        <span class="fu">name:</span><span class="at"> new_password</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">        <span class="fu">title:</span><span class="at"> new_password</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;New db password&#39;</span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb7-29" data-line-number="29">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-31" data-line-number="31">        <span class="fu">name:</span><span class="at"> role</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32">        <span class="fu">title:</span><span class="at"> role</span></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;Database role to grant the new user&#39;</span></a></code></pre></div>
<p>Corresponding job config <code>rundeck-project/jobs/CreateDbUser.yaml</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> CreateDbUser</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> CreateDbUser</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> web_1</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="fu">options:</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Master db user version</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">    <span class="fu">name:</span><span class="at"> master_user_version</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">    <span class="fu">required:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">    <span class="fu">value:</span><span class="at"> </span><span class="st">&#39;1&#39;</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Web db user version</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">    <span class="fu">name:</span><span class="at"> web_user_version</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">    <span class="kw">-</span> <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17">        <span class="fu">master_db_user:</span><span class="at"> master${option.master_user_version}</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18">        <span class="fu">master_db_password:</span><span class="at"> keys/projects/hello-project/db/master${option.master_user_version}</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19">        <span class="fu">new_user:</span><span class="at"> web${option.web_user_version}</span></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">        <span class="fu">new_password:</span><span class="at"> keys/projects/hello-project/db/web${option.web_user_version}</span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21">        <span class="fu">role:</span><span class="at"> web</span></a>
<a class="sourceLine" id="cb8-22" data-line-number="22">      <span class="fu">type:</span><span class="at"> CreateDBUser</span></a>
<a class="sourceLine" id="cb8-23" data-line-number="23">    <span class="fu">keepgoing:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb8-24" data-line-number="24">    <span class="fu">strategy:</span><span class="at"> node-first</span></a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=CreateDbUser JOB_OPTIONS=<span class="st">&#39;-web_user_version 2&#39;</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co"># Found matching job: CreateDbUser CreateDbUser</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># Execution started: [7] CreateDbUser /CreateDbUser &lt;http://127.0.0.1:4440/project/hello-project/execution/show/7&gt;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="ex">GRANT</span> ROLE</a></code></pre></div>
<h3 id="deleting-the-old-db-login">Deleting the old db login</h3>
<p>Updating <code>rundeck-plugins/db-creds-plugin/plugin.yaml</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb10-1" data-line-number="1">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> DeleteDBUser</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="fu">script-interpreter:</span><span class="at"> /bin/bash</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">    <span class="fu">script-file:</span><span class="at"> delete-db-user.sh</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    <span class="fu">script-args:</span><span class="at"> ${config.master_db_user} ${config.master_db_password} ${config.user}</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">        <span class="fu">name:</span><span class="at"> master_db_user</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">        <span class="fu">title:</span><span class="at"> master_db_user</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;master db user&#39;</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">        <span class="fu">default:</span><span class="at"> master1</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">        <span class="fu">name:</span><span class="at"> master_db_password</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">        <span class="fu">title:</span><span class="at"> master_db_password</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;master db user password&#39;</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">        <span class="fu">default:</span><span class="at"> keys/projects/hello-project/db/master1</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">        <span class="fu">name:</span><span class="at"> user</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">        <span class="fu">title:</span><span class="at"> user</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;db user to delete&#39;</span></a></code></pre></div>
<p>And the corresponding job <code>rundeck-project/jobs/DeleteDbUser.yaml</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> DeleteDbUser</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> DeleteDbUser</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> web_1</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  <span class="fu">options:</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Master db user version</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">    <span class="fu">name:</span><span class="at"> master_user_version</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">    <span class="fu">required:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">    <span class="fu">value:</span><span class="at"> </span><span class="st">&#39;1&#39;</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Web db user version</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">    <span class="fu">name:</span><span class="at"> web_user_version</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15">    <span class="kw">-</span> <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17">        <span class="fu">master_db_user:</span><span class="at"> master${option.master_user_version}</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18">        <span class="fu">master_db_password:</span><span class="at"> keys/projects/hello-project/db/master${option.master_user_version}</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19">        <span class="fu">user:</span><span class="at"> web${option.web_user_version}</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20">      <span class="fu">type:</span><span class="at"> DeleteDBUser</span></a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=DeleteDbUser JOB_OPTIONS=<span class="st">&#39;-web_user_version 1&#39;</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co"># Found matching job: DeleteDbUser DeleteDbUser</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co"># Execution started: [9] DeleteDbUser /DeleteDbUser &lt;http://127.0.0.1:4440/project/hello-project/execution/show/9&gt;</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="ex">DROP</span> ROLE</a></code></pre></div>
<h3 id="tying-it-all-together">Tying it all together</h3>
<p>To tie all the steps together into a single job, we can use job reference steps. <code>rundeck-project/jobs/RotateDbCredentials.yaml</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> RotateDbCredentials</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> RotateDbCredentials</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="fu">options:</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> master_user_version</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    <span class="fu">name:</span><span class="at"> master_user_version</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">    <span class="fu">value:</span><span class="at"> </span><span class="st">&#39;1&#39;</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> web_user_version</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">    <span class="fu">name:</span><span class="at"> web_user_version</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> prev_web_user_version</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11">    <span class="fu">name:</span><span class="at"> prev_web_user_version</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">        <span class="fu">name:</span><span class="at"> CreateDbUser</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17">        <span class="fu">uuid:</span><span class="at"> CreateDbUser</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18">        <span class="fu">nodeStep:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">        <span class="fu">importOptions:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21">        <span class="fu">name:</span><span class="at"> UpdateAppConfig</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22">        <span class="fu">uuid:</span><span class="at"> UpdateAppConfig</span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23">        <span class="fu">nodeStep:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24">        <span class="fu">args:</span><span class="at"> -dbuser web${option.web_user_version}</span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26">        <span class="fu">name:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb13-27" data-line-number="27">        <span class="fu">name:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb13-28" data-line-number="28">        <span class="fu">nodeStep:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb13-29" data-line-number="29">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30">        <span class="fu">name:</span><span class="at"> DeleteDbUser</span></a>
<a class="sourceLine" id="cb13-31" data-line-number="31">        <span class="fu">uuid:</span><span class="at"> DeleteDbUser</span></a>
<a class="sourceLine" id="cb13-32" data-line-number="32">        <span class="fu">nodeStep:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33">        <span class="fu">args:</span><span class="at"> -master_user_version ${option.master_user_version} -web_user_version ${option.prev_web_user_version}</span></a>
<a class="sourceLine" id="cb13-34" data-line-number="34">    <span class="fu">keepgoing:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb13-35" data-line-number="35">    <span class="fu">strategy:</span><span class="at"> sequential</span></a></code></pre></div>
<p>We’ll need a new user and password, which we can create in the Key Storage:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="bu">echo</span> <span class="st">&#39;An0th3r!S3cr3t&#39;</span> <span class="op">&gt;</span> rundeck-project/key-storage/keys/projects/hello-project/db/web3</a></code></pre></div>
<p>Then running the job should push the new key. We need to specify both the new version and the previous version that needs deleting.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=RotateDbCredentials JOB_OPTIONS=<span class="st">&#39;-web_user_version 3 -prev_web_user_version 2&#39;</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co"># Created: keys/projects/hello-project/db/web3 [password]</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co"># Found matching job: RotateDbCredentials RotateDbCredentials</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co"># Execution started: [7] RotateDbCredentials /RotateDbCredentials &lt;http://127.0.0.1:4440/project/hello-project/execution/show/7&gt;</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="ex">GRANT</span> ROLE</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="ex">Updating</span> /etc/web.yaml with db user credentials: web3</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="ex">Updating</span> /etc/web.yaml with db user credentials: web3</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="ex">Restarting</span> python3 app</a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="ex">Waiting</span> for app to stop</a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="ex">Waiting</span> for app to start and return 200</a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="ex">Restarting</span> python3 app</a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="ex">Waiting</span> for app to stop</a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="ex">Waiting</span> for app to start and return 200</a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb15-19" data-line-number="19"><span class="ex">DROP</span> ROLE</a></code></pre></div>
<p>And there you have it: a single command to rotate your database credentials!</p>
</section>
</div>
</div>
</div>
</div>
<div class="container">
    <nav class="breadcrumb" aria-label="breadcrumbs">
        <div class="columns">
            <div class="column is-two-thirds">
            <ul>
                
                    
                        <li><a href="../index.html">Rundeck Documentation (3.1.0)</a></li>
                    
                
                <li ><a href="index.html">Tutorials</a></li>
                <li class="active"><a href="custom-script-plugin---db-credential-rotation.html">Custom Script Plugin - DB Credential Rotation</a></li>
            </ul>
            </div>
            <div class="column">
            <ul>
                <li class="previous"><a href="custom-script-plugin---hello-world.html"><i class="fas fa-arrow-left"></i>Custom Script Plugin - Hello World</a></li>
                <li class="next"><a href="log-filters.html">Log Filters <i class="fas fa-arrow-right"></i></a></li>
            </ul>
            </div>
        </div>
    </nav>
    <div class="breadcrumb-footer">
        <a class="btn btn-link bottom" href="https://github.com/rundeck/docs/issues/new?labels=bug&title=Documentation+bug+in+file+tutorials/custom-script-plugin-db-cred-rotation.md&template=documentation-bug.md"> <i class="fas fa-flag"></i> Report a problem </a>
        <a class="btn btn-link bottom btn-edit-this-page" href="https://github.com/rundeck/docs/edit/3.0.x/en/tutorials/custom-script-plugin-db-cred-rotation.md"><i class="fas fa-pencil-alt"></i> Edit this page</a>
    </div>
</div>
<footer class="brand-footer">
  <div class="container">
    <div class="columns" style="margin-bottom:0;padding-top:5em;padding-bottom:5em">
      <div class="column is-1" style="padding-top:1.3em"><span><svg width="39" height="40" viewBox="0 0 39 40"
            xmlns="http://www.w3.org/2000/svg">
            <g fill="#F7403A" fill-rule="evenodd">
              <path
                d="M0 39.175h26.17l4.883-7.702H4.883zM31.053 8.368L26.17.665H0l4.883 7.703zM35.936 16.07H9.766l2.44 3.85-2.44 3.851h26.17l2.44-3.852z">
              </path>
            </g>
          </svg></span></div>
      <div class="column is-4">
        <div class="contact"><a href="tel:8336774376" class="phone is-size-3 has-text-weight-bold">(833) OPS-HERO</a>
          <div class="address address has-text-weight-bold is-size-5" style="margin-top:1em">2317
            Broadway, Suite 130
            <br>Redwood City, CA 94063
          </div>
          <div>
            <ul class="social-links">
              <li class="social-link"><a href="https://www.linkedin.com/company/17928739" role="menuitem"
                  target="_blank" aria-label="Linkedin" class="button social-link__icon"><svg aria-hidden="true"
                    focusable="false" data-prefix="fab" data-icon="linkedin" role="img"
                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"
                    class="svg-inline--fa fa-linkedin fa-w-14">
                    <path fill="currentColor"
                      d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"
                      class=""></path>
                  </svg></a></li>
              <li class="social-link"><a href="https://twitter.com/rundeck" role="menuitem" target="_blank"
                  aria-label="Twitter" class="button social-link__icon"><svg aria-hidden="true" focusable="false"
                    data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 512 512" class="svg-inline--fa fa-twitter fa-w-16">
                    <path fill="currentColor"
                      d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"
                      class=""></path>
                  </svg></a></li>
            </ul>
          </div>
          <div class="copyright">
            <span class="copyright-text" style="font-weight:500;font-size:14px">©2019 Rundeck.
              All Rights Reserved.</span> 
              <br />
              <span class="generated-date" title="2019-08-06T01:52:36UTC">2019-08-06T01:52:36UTC</span>
          </div>
        </div>
      </div>
      <div class="column">
        <ul class="marketing-site-nav is-size-5 has-text-weight-semibold">
          <li><a href="https://www.rundeck.com/about" role="menuitem">About</a>
          </li>
          <li><a href="https://www.rundeck.com/about/team" role="menuitem">Team</a></li>
          <li><a href="https://www.rundeck.com/careers" role="menuitem">Careers</a></li>
          <li><a href="https://www.rundeck.com/news" role="menuitem">News</a>
          </li>
          <li><a href="https://www.rundeck.com/events" role="menuitem">Events</a>
          </li>
          <li><a href="https://www.rundeck.com/privacy-policy" role="menuitem">Privacy Policy</a></li>
          <li><a href="https://www.rundeck.com/terms" role="menuitem">Terms of
              Use</a></li>
          <li><a href="https://www.rundeck.com/contact" role="menuitem">Contact</a></li>
          <li><a href="https://www.rundeck.com/demo" role="menuitem">Request a
              Demo</a></li>
        </ul>
      </div>
    </div>
    <div class="creative-commons">
      <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Rundeck Documentation</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://rundeck.com" property="cc:attributionName" rel="cc:attributionURL">Rundeck, Inc</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License. </a>
    </div>
  </div>
</footer>

<script type="text/javascript">
   var _gaq = [['_setAccount', 'UA-529275-13'], ['_trackPageview']];
   (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
   })(document, 'script');
  </script>

<script>window.markdeepOptions={mode:'html'};</script>
<!-- Markdeep: --><script src="../markdeep.min.js"></script>
<!-- <script src="https://casual-effects.com/markdeep/latest/markdeep.min.js"></script> -->

<!-- Start of HubSpot Embed Code -->
<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/2768099.js"></script>
<!-- End of HubSpot Embed Code -->
<div class='scrolltop'>
<div class='scrollitem icon'>
<i class="fas fa-chevron-up" ></i>
</div>
</div>
</body>
</html>
