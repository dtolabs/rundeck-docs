<!DOCTYPE html>
<html>
<head>
  <title>Use case: database credential rotation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="generator" content="pandoc" />
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="../jquery.hotkeys.js"></script>
<script src="../jquery.autocomplete.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript">
window._pageRelpath="../";
jQuery(function(){
  jQuery('table').addClass('table table-condensed table-responsive'); 
  jQuery('[data-toggle="popover"]').popover();
});
</script>
<script src="../docs-autocomplete.js"></script>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../style.css" type="text/css" />
</head>
<body data-spy="scroll" data-target=".toc-nav">
<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="container-fluid">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="https://www.rundeck.com/open-source">
      Rundeck
      <p class="small rd_version">← Return to Rundeck Project</p>
    </a>
  </div>
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <form class="navbar-form navbar-right" role="search"  action="/search/">
      <div class="form-group">
        <input type="text" class="form-control navquery" name="q" placeholder="Search" id="searchQuery">
      </div>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>
  </div>
  </div>
</nav>

<div class="container top breadcrumb_holder">
<div class="row">
<div class="col-sm-6" id="#breadcrumbstop">

<div class="navquerytoggle collapse" aria-expanded="false">
<div class="input-group ">
    <a class="input-group-addon btn btn-xs" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbstop"><i class="glyphicon glyphicon-search"></i></a>
    <input type="text" class="form-control navquery  " name="q" placeholder="Search" autofocus="true">    
    <a class="input-group-addon btn btn-xs" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbstop"><i class="glyphicon glyphicon-remove"></i></a>
</div>
</div>

<ol class="breadcrumb top collapse in navquerytoggle" aria-expanded="true">
    <li class="navquerytrigger collapse" title="Find a page by name. (Keyboard shortcut: q)" data-toggle="tooltip" data-container="body">
        <a class="btn btn-xs btn-link" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbstop">
            <i class="glyphicon glyphicon-search"></i>
        </a>
    </li>

    
        <li><a href="../index.html">Rundeck Documentation (3.0.12)</a></li>
    
    
    <li ><a href="index.html">Tutorials</a></li>
    <li class="active"><a href="custom-script-plugin---db-credential-rotation.html">Custom Script Plugin - DB Credential Rotation</a></li>
</ol>
</div>
<div class="col-sm-6">
    <ul class="pager">
      <li class="previous"><a href="custom-script-plugin---hello-world.html"><i class="glyphicon glyphicon-arrow-left"></i> Custom Script Plugin - Hello World</a></li>
      <li class="next"><a href="log-filters.html">Log Filters <i class="glyphicon glyphicon-arrow-right"></i></a></li>
    </ul>
</div>
</div>
<div class="row">
<div class="col-sm-12 text-right">
    <a class="btn btn-link top" href="https://github.com/rundeck/docs/issues/new?labels=bug&title=Documentation+bug+in+file+tutorials/custom-script-plugin-db-cred-rotation.md&template=documentation-bug.md"><i class="glyphicon glyphicon-flag"></i> Report a problem</a>
    <a class="btn btn-link top btn-edit-this-page" href="https://github.com/rundeck/docs/edit/3.0.x/en/tutorials/custom-script-plugin-db-cred-rotation.md"><i class="glyphicon glyphicon-pencil"></i>  Edit this page</a>
</div>
</div>
</div>
<div id="docbody">
<div class="container">
<div class="row">
<div class="col-sm-3 toc-nav">
<div class="nav">
<ul>
<li><a href="#the-problem">The problem</a></li>
<li><a href="#addressing-the-problem-with-rundeck">Addressing the problem with Rundeck</a><ul>
<li><a href="#secure-secrets-handling">Secure secrets handling</a></li>
<li><a href="#critical-logic-is-tested-ahead-of-time">Critical logic is tested ahead of time</a></li>
<li><a href="#ease-of-use-encourages-proactive-security">Ease of use encourages proactive security</a></li>
</ul></li>
<li><a href="#automating-credential-rotation-with-rundeck">Automating credential rotation with Rundeck</a><ul>
<li><a href="#restarting-the-apps">Restarting the apps</a></li>
<li><a href="#modifying-the-app-config">Modifying the app config</a></li>
<li><a href="#creating-the-new-db-login">Creating the new db login</a></li>
<li><a href="#deleting-the-old-db-login">Deleting the old db login</a></li>
<li><a href="#tying-it-all-together">Tying it all together</a></li>
</ul></li>
</ul>
</div>
</div>
<div class="col-sm-9">
<div class="page-header">
<h1 class="title">Use case: database credential rotation</h1>
</div>
<p>Now that we know how to create custom workflow step script plugin in the <a href="custom-script-plugin---hello-world.html" title="Tutorials - Custom Script Plugin - Hello World">hello world tutorial</a>, let’s walk through a real world use case: rotation database credentials. Credential rotation has traditionally been a complicated, thankless administrative chore. It’s the type of work that might be labeled <a href="https://landing.google.com/sre/book/chapters/eliminating-toil.html">toil</a> and exactly the kind of work that Rundeck has been designed to streamline.</p>
<p>The end result of this tutorial as well as a Docker environment to run it in can be found on <a href="https://github.com/clofresh/rundeck-playground">GitHub</a></p>
<h2 id="the-problem">The problem</h2>
<p>What’s difficult about database credential rotation?</p>
<ul>
<li>It involves multiple steps across multiple nodes in your production cluster.</li>
<li>It’s necessary to handle secrets in the form of the new credentials you’re creating, plus credentials of a super user that can create the new login.</li>
<li>Manually run steps are error prone and mistakes can potentially cause a site-wide outage if your app can’t authenticate with the database anymore.</li>
</ul>
<h2 id="addressing-the-problem-with-rundeck">Addressing the problem with Rundeck</h2>
<p>By creating a custom script plugin to interact with the database, its downstream clients and the Rundeck Key Storage, we can automate the creation and deployment of the new credentials as well as safely handle the decomissioning of the old credentials.</p>
<h3 id="secure-secrets-handling">Secure secrets handling</h3>
<p>Since the Key Storage stores the credentials, the administrator triggering the credential rotation doesn’t ever need to see the actual credentials of the database super user or the newly generated database user.</p>
<h3 id="critical-logic-is-tested-ahead-of-time">Critical logic is tested ahead of time</h3>
<p>The logic for creating the database login is encapsulated in a script that has been tested prior to actually needing to rotate the credentials, so we avoid putting a human in the stressful, error-prone situation of having to figure out correct syntax to run on a live system on the fly.</p>
<p>Similarly, the app restart logic is encapsulated as well, with health check logic as an extra safety measure to halt the process in case something has gone wrong before applying the change to the whole cluster.</p>
<h3 id="ease-of-use-encourages-proactive-security">Ease of use encourages proactive security</h3>
<p>Lastly, by creating a single button solution to rotate database credentials, we’re much more likely to rotate our credentials on a regular basis to mitigate potential security risks, rather than only after a security incident has already occured.</p>
<h2 id="automating-credential-rotation-with-rundeck">Automating credential rotation with Rundeck</h2>
<p>In order to automate the credential rotation, we need to automate the individual steps, then orchestrate the steps in a single process. The steps we want to automate are:</p>
<ul>
<li>Creating a new database login</li>
<li>Updating the application configuration to use the new database login</li>
<li>Restarting the applications to apply the configuration change</li>
<li>Deleting the old database login</li>
</ul>
<h3 id="restarting-the-apps">Restarting the apps</h3>
<p>We can start with restarting the applications because that’s something we can test on its own before proceeding. We’ll create a new plugin metadata file <code>rundeck-plugins/db-creds/plugin.yaml</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">name:</span><span class="at"> Database credential management</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">version:</span><span class="at"> 1</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="fu">rundeckPluginVersion:</span><span class="at"> 1.2</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="fu">author:</span><span class="at"> Carlo Cabanilla</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="fu">date:</span><span class="at"> 2018-07-20</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="fu">url:</span><span class="at"> http://rundeck.org/</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="fu">providers:</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    <span class="fu">script-interpreter:</span><span class="at"> /bin/bash</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    <span class="fu">script-file:</span><span class="at"> restart.sh</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">    <span class="fu">script-args:</span><span class="at"> ${config.process} ${config.health_url}</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">        <span class="fu">name:</span><span class="at"> process</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">        <span class="fu">title:</span><span class="at"> process</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">        <span class="fu">description:</span><span class="at"> the process to restart</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">        <span class="fu">name:</span><span class="at"> health_url</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">        <span class="fu">title:</span><span class="at"> health_url</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">        <span class="fu">description:</span><span class="at"> the http endpoint to poll to check that it&#39;s healthy</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">        <span class="fu">default:</span><span class="at"> http://localhost:8080</span></a></code></pre></div>
<p>Our restart script takes 2 parameters: the name of the process on the node, and a url that we can poll to check that it’s healthy. The implementation of the restart script is specific to the Docker playground environment so we’ll leave out the details, but from a high level it:</p>
<ul>
<li>Kills the process and lets the supervising parent process restart it</li>
<li>Polls the health check url until it returns healthy or times out</li>
<li>Exits with an error code if it times out to let the calling process know whether to continue or not with downstream steps</li>
</ul>
<p>In order to be able to run the restart, we create a job that specifies the nodes to run it on and the input parameters. <code>rundeck-project/jobs/RestartApp.yaml</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> web_.*</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    <span class="kw">-</span> <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">        <span class="fu">health_url:</span><span class="at"> http://localhost:8080</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">        <span class="fu">process:</span><span class="at"> python3</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">      <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">      <span class="fu">type:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    <span class="fu">keepgoing:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    <span class="fu">strategy:</span><span class="at"> node-first</span></a></code></pre></div>
<p>We specify a <code>uuid</code> here so that we know how to refer to it from other jobs, otherwise Rundeck will assign a random uuid.</p>
<p>We can test the restart using our <a href="https://github.com/clofresh/rundeck-playground">playground Docker environment</a>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=RestartApp</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># Found matching job: RestartApp RestartApp</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co"># Execution started: [5] RestartApp /RestartApp &lt;http://127.0.0.1:4440/project/hello-project/execution/show/5&gt;</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="ex">Restarting</span> python3 app</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="ex">Waiting</span> for app to stop</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="ex">Waiting</span> for app to start and return 200</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="ex">Restarting</span> python3 app</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="ex">Waiting</span> for app to stop</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="ex">Waiting</span> for app to start and return 200</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="ex">Done</span></a></code></pre></div>
<h3 id="modifying-the-app-config">Modifying the app config</h3>
<p>Now we can create a step to update the configured database login on the application nodes. In your production environment you might use a configuration management tool like Ansible or Chef to accomplish this but here we use a simple Python script. We can add this to the <code>providers</code> key of <code>rundeck-plugins/db-creds/plugin.yaml</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb4-1" data-line-number="1">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> UpdateDBCredentials</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    <span class="fu">script-interpreter:</span><span class="at"> /usr/local/bin/python3</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">    <span class="fu">script-file:</span><span class="at"> change_password.py</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="fu">script-args:</span><span class="at"> /etc/web.yaml ${config.user} ${config.password}</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">        <span class="fu">name:</span><span class="at"> user</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">        <span class="fu">title:</span><span class="at"> user</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;db user&#39;</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">        <span class="fu">name:</span><span class="at"> password</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">        <span class="fu">title:</span><span class="at"> password</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;db password&#39;</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a></code></pre></div>
<p>Note the <code>valueConversion: &quot;STORAGE_PATH_AUTOMATIC_READ&quot;</code> setting to able to refer to a path in Key Storage for the database password.</p>
<p>Corresponding job config <code>rundeck-project/jobs/UpdateAppConfig.yaml</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> UpdateAppConfig</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> UpdateAppConfig</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> web_.*</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="fu">options:</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Database user</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    <span class="fu">name:</span><span class="at"> dbuser</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  <span class="fu">scheduleEnabled:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    <span class="kw">-</span> <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14">        <span class="fu">user:</span><span class="at"> ${option.dbuser}</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">        <span class="fu">password:</span><span class="at"> keys/projects/hello-project/db/${option.dbuser}</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16">      <span class="fu">type:</span><span class="at"> UpdateDBCredentials</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17">    <span class="fu">keepgoing:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18">    <span class="fu">strategy:</span><span class="at"> node-first</span></a></code></pre></div>
<p>In the job, we expose an option to the job user to specify the database user to set the config to. We use that value as part of the Key Storage path to look up the password. By using a naming convention for the key path, we hide the details of the Key Storage setup from the job user.</p>
<p>We can test it with:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=UpdateAppConfig JOB_OPTIONS=<span class="st">&#39;-dbuser web2&#39;</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co"># Found matching job: UpdateAppConfig UpdateAppConfig</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co"># Execution started: [6] UpdateAppConfig /UpdateAppConfig &lt;http://127.0.0.1:4440/project/hello-project/execution/show/6&gt;</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="ex">Updating</span> /etc/web.yaml with db user credentials: web2</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="ex">Updating</span> /etc/web.yaml with db user credentials: web2</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="ex">Done</span></a></code></pre></div>
<h3 id="creating-the-new-db-login">Creating the new db login</h3>
<p>Creating a new database login requires a super user database login plus a user and password for the new login. Add this to the <code>providers</code> key of <code>rundeck-plugins/db-creds/plugin.yaml</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb7-1" data-line-number="1">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> CreateDBUser</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    <span class="fu">script-interpreter:</span><span class="at"> /bin/bash</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    <span class="fu">script-file:</span><span class="at"> create-db-user.sh</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    <span class="fu">script-args:</span><span class="at"> ${config.master_db_user} ${config.master_db_password} ${config.new_user} ${config.new_password} ${config.role}</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">        <span class="fu">name:</span><span class="at"> master_db_user</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">        <span class="fu">title:</span><span class="at"> master_db_user</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;master db user&#39;</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">        <span class="fu">default:</span><span class="at"> master1</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">        <span class="fu">name:</span><span class="at"> master_db_password</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">        <span class="fu">title:</span><span class="at"> master_db_password</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;master db user password&#39;</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17">        <span class="fu">default:</span><span class="at"> keys/projects/hello-project/db/master1</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21">        <span class="fu">name:</span><span class="at"> new_user</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22">        <span class="fu">title:</span><span class="at"> new_user</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;New db user&#39;</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">        <span class="fu">name:</span><span class="at"> new_password</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">        <span class="fu">title:</span><span class="at"> new_password</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;New db password&#39;</span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb7-29" data-line-number="29">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb7-31" data-line-number="31">        <span class="fu">name:</span><span class="at"> role</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32">        <span class="fu">title:</span><span class="at"> role</span></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;Database role to grant the new user&#39;</span></a></code></pre></div>
<p>Corresponding job config <code>rundeck-project/jobs/CreateDbUser.yaml</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> CreateDbUser</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> CreateDbUser</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> web_1</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="fu">options:</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Master db user version</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">    <span class="fu">name:</span><span class="at"> master_user_version</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">    <span class="fu">required:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">    <span class="fu">value:</span><span class="at"> </span><span class="st">&#39;1&#39;</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Web db user version</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">    <span class="fu">name:</span><span class="at"> web_user_version</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">    <span class="kw">-</span> <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17">        <span class="fu">master_db_user:</span><span class="at"> master${option.master_user_version}</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18">        <span class="fu">master_db_password:</span><span class="at"> keys/projects/hello-project/db/master${option.master_user_version}</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19">        <span class="fu">new_user:</span><span class="at"> web${option.web_user_version}</span></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">        <span class="fu">new_password:</span><span class="at"> keys/projects/hello-project/db/web${option.web_user_version}</span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21">        <span class="fu">role:</span><span class="at"> web</span></a>
<a class="sourceLine" id="cb8-22" data-line-number="22">      <span class="fu">type:</span><span class="at"> CreateDBUser</span></a>
<a class="sourceLine" id="cb8-23" data-line-number="23">    <span class="fu">keepgoing:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb8-24" data-line-number="24">    <span class="fu">strategy:</span><span class="at"> node-first</span></a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=CreateDbUser JOB_OPTIONS=<span class="st">&#39;-web_user_version 2&#39;</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co"># Found matching job: CreateDbUser CreateDbUser</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># Execution started: [7] CreateDbUser /CreateDbUser &lt;http://127.0.0.1:4440/project/hello-project/execution/show/7&gt;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="ex">GRANT</span> ROLE</a></code></pre></div>
<h3 id="deleting-the-old-db-login">Deleting the old db login</h3>
<p>Updating <code>rundeck-plugins/db-creds-plugin/plugin.yaml</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb10-1" data-line-number="1">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> DeleteDBUser</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="fu">service:</span><span class="at"> RemoteScriptNodeStep</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    <span class="fu">plugin-type:</span><span class="at"> script</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="fu">script-interpreter:</span><span class="at"> /bin/bash</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">    <span class="fu">script-file:</span><span class="at"> delete-db-user.sh</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    <span class="fu">script-args:</span><span class="at"> ${config.master_db_user} ${config.master_db_password} ${config.user}</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    <span class="fu">config:</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">        <span class="fu">name:</span><span class="at"> master_db_user</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">        <span class="fu">title:</span><span class="at"> master_db_user</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;master db user&#39;</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">        <span class="fu">default:</span><span class="at"> master1</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">        <span class="fu">name:</span><span class="at"> master_db_password</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">        <span class="fu">title:</span><span class="at"> master_db_password</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;master db user password&#39;</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">        <span class="fu">default:</span><span class="at"> keys/projects/hello-project/db/master1</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">        <span class="fu">renderingOptions:</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">          <span class="fu">valueConversion:</span><span class="at"> </span><span class="st">&quot;STORAGE_PATH_AUTOMATIC_READ&quot;</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">      <span class="kw">-</span> <span class="fu">type:</span><span class="at"> String</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">        <span class="fu">name:</span><span class="at"> user</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">        <span class="fu">title:</span><span class="at"> user</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23">        <span class="fu">description:</span><span class="at"> </span><span class="st">&#39;db user to delete&#39;</span></a></code></pre></div>
<p>And the corresponding job <code>rundeck-project/jobs/DeleteDbUser.yaml</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> DeleteDbUser</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> DeleteDbUser</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="fu">nodefilters:</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">    <span class="fu">filter:</span><span class="at"> web_1</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  <span class="fu">options:</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Master db user version</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">    <span class="fu">name:</span><span class="at"> master_user_version</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">    <span class="fu">required:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">    <span class="fu">value:</span><span class="at"> </span><span class="st">&#39;1&#39;</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> Web db user version</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">    <span class="fu">name:</span><span class="at"> web_user_version</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15">    <span class="kw">-</span> <span class="fu">nodeStep:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16">      <span class="fu">configuration:</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17">        <span class="fu">master_db_user:</span><span class="at"> master${option.master_user_version}</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18">        <span class="fu">master_db_password:</span><span class="at"> keys/projects/hello-project/db/master${option.master_user_version}</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19">        <span class="fu">user:</span><span class="at"> web${option.web_user_version}</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20">      <span class="fu">type:</span><span class="at"> DeleteDBUser</span></a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=DeleteDbUser JOB_OPTIONS=<span class="st">&#39;-web_user_version 1&#39;</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co"># Found matching job: DeleteDbUser DeleteDbUser</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co"># Execution started: [9] DeleteDbUser /DeleteDbUser &lt;http://127.0.0.1:4440/project/hello-project/execution/show/9&gt;</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="ex">DROP</span> ROLE</a></code></pre></div>
<h3 id="tying-it-all-together">Tying it all together</h3>
<p>To tie all the steps together into a single job, we can use job reference steps. <code>rundeck-project/jobs/RotateDbCredentials.yaml</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> RotateDbCredentials</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">  <span class="fu">uuid:</span><span class="at"> RotateDbCredentials</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="fu">options:</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> master_user_version</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    <span class="fu">name:</span><span class="at"> master_user_version</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">    <span class="fu">value:</span><span class="at"> </span><span class="st">&#39;1&#39;</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> web_user_version</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">    <span class="fu">name:</span><span class="at"> web_user_version</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">  <span class="kw">-</span> <span class="fu">label:</span><span class="at"> prev_web_user_version</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11">    <span class="fu">name:</span><span class="at"> prev_web_user_version</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12">    <span class="fu">required:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">  <span class="fu">sequence:</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14">    <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">        <span class="fu">name:</span><span class="at"> CreateDbUser</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17">        <span class="fu">uuid:</span><span class="at"> CreateDbUser</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18">        <span class="fu">nodeStep:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">        <span class="fu">importOptions:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21">        <span class="fu">name:</span><span class="at"> UpdateAppConfig</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22">        <span class="fu">uuid:</span><span class="at"> UpdateAppConfig</span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23">        <span class="fu">nodeStep:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24">        <span class="fu">args:</span><span class="at"> -dbuser web${option.web_user_version}</span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26">        <span class="fu">name:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb13-27" data-line-number="27">        <span class="fu">name:</span><span class="at"> RestartApp</span></a>
<a class="sourceLine" id="cb13-28" data-line-number="28">        <span class="fu">nodeStep:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb13-29" data-line-number="29">    <span class="kw">-</span> <span class="fu">jobref:</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30">        <span class="fu">name:</span><span class="at"> DeleteDbUser</span></a>
<a class="sourceLine" id="cb13-31" data-line-number="31">        <span class="fu">uuid:</span><span class="at"> DeleteDbUser</span></a>
<a class="sourceLine" id="cb13-32" data-line-number="32">        <span class="fu">nodeStep:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33">        <span class="fu">args:</span><span class="at"> -master_user_version ${option.master_user_version} -web_user_version ${option.prev_web_user_version}</span></a>
<a class="sourceLine" id="cb13-34" data-line-number="34">    <span class="fu">keepgoing:</span><span class="at"> false</span></a>
<a class="sourceLine" id="cb13-35" data-line-number="35">    <span class="fu">strategy:</span><span class="at"> sequential</span></a></code></pre></div>
<p>We’ll need a new user and password, which we can create in the Key Storage:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="bu">echo</span> <span class="st">&#39;An0th3r!S3cr3t&#39;</span> <span class="op">&gt;</span> rundeck-project/key-storage/keys/projects/hello-project/db/web3</a></code></pre></div>
<p>Then running the job should push the new key. We need to specify both the new version and the previous version that needs deleting.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="fu">make</span> rd-run-job JOB=RotateDbCredentials JOB_OPTIONS=<span class="st">&#39;-web_user_version 3 -prev_web_user_version 2&#39;</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co"># Created: keys/projects/hello-project/db/web3 [password]</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co"># Found matching job: RotateDbCredentials RotateDbCredentials</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co"># Execution started: [7] RotateDbCredentials /RotateDbCredentials &lt;http://127.0.0.1:4440/project/hello-project/execution/show/7&gt;</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="ex">GRANT</span> ROLE</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="ex">Updating</span> /etc/web.yaml with db user credentials: web3</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="ex">Updating</span> /etc/web.yaml with db user credentials: web3</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="ex">Restarting</span> python3 app</a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="ex">Waiting</span> for app to stop</a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="ex">Waiting</span> for app to start and return 200</a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="ex">Restarting</span> python3 app</a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="ex">Waiting</span> for app to stop</a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="ex">Waiting</span> for app to start and return 200</a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="ex">Done</span></a>
<a class="sourceLine" id="cb15-19" data-line-number="19"><span class="ex">DROP</span> ROLE</a></code></pre></div>
<p>And there you have it: a single command to rotate your database credentials!</p>
</div>
</div>
</div>
</div>

<div class="container bottom breadcrumb_holder">
<div class="row">
<div class="col-sm-6" id="#breadcrumbsbottom">

<div class="navquerytoggle collapse" aria-expanded="false">
<div class="input-group ">
    <a class="input-group-addon btn btn-xs" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbsbottom"><i class="glyphicon glyphicon-search"></i></a>
    <input type="text" class="form-control navquery  " name="q" placeholder="Search" autofocus="true">    
    <a class="input-group-addon btn btn-xs" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbsbottom"><i class="glyphicon glyphicon-remove"></i></a>
</div>
</div>

<ol class="breadcrumb bottom collapse in navquerytoggle" aria-expanded="true">
    <li class="navquerytrigger collapse" title="Find a page by name. (Keyboard shortcut: q)" data-toggle="tooltip" data-container="body">
        <a class="btn btn-xs btn-link" data-toggle="collapse" data-target=".navquerytoggle"  data-parent="#breadcrumbsbottom">
            <i class="glyphicon glyphicon-search"></i>
        </a>
    </li>

    
        <li><a href="../index.html">Rundeck Documentation (3.0.12)</a></li>
    
    
    <li ><a href="index.html">Tutorials</a></li>
    <li class="active"><a href="custom-script-plugin---db-credential-rotation.html">Custom Script Plugin - DB Credential Rotation</a></li>
</ol>
</div>
<div class="col-sm-6">
    <ul class="pager">
      <li class="previous"><a href="custom-script-plugin---hello-world.html"><i class="glyphicon glyphicon-arrow-left"></i> Custom Script Plugin - Hello World</a></li>
      <li class="next"><a href="log-filters.html">Log Filters <i class="glyphicon glyphicon-arrow-right"></i></a></li>
    </ul>
</div>
</div>
<div class="row">
<div class="col-sm-12 text-right">
    <a class="btn btn-link bottom" href="https://github.com/rundeck/docs/issues/new?labels=bug&title=Documentation+bug+in+file+tutorials/custom-script-plugin-db-cred-rotation.md&template=documentation-bug.md"><i class="glyphicon glyphicon-flag"></i> Report a problem</a>
    <a class="btn btn-link bottom btn-edit-this-page" href="https://github.com/rundeck/docs/edit/3.0.x/en/tutorials/custom-script-plugin-db-cred-rotation.md"><i class="glyphicon glyphicon-pencil"></i>  Edit this page</a>
</div>
</div>
</div>
<div class='container footer'>

<div class="row">
	<footer class="copy col-sm-12 text-muted">

<p>
<a class="btn btn-info btn-try-rundeck-pro" href="http://rundeck.com/" data-toggle="popover" data-trigger="hover" 
data-content="<ul class=&quot;list-unstyled&quot;>
	<li><i class=&quot;glyphicon glyphicon-gift&quot;></i> Try Rundeck Enterprise for Free</li>
	<li><i class=&quot;glyphicon glyphicon-flash&quot;></i> Get Exclusive Features</li>
	<li><i class=&quot;glyphicon glyphicon-briefcase&quot;></i> Get Professional Support</li>
	<li><i class=&quot;glyphicon glyphicon-heart&quot;></i> Support Open-source Development</li>
	<li><i class=&quot;glyphicon glyphicon-thumbs-up&quot;></i> Get home by 5 </li>
</ul>" data-html="true">
<i class="glyphicon glyphicon-hand-right"></i>
Try Rundeck Enterprise
</a>
</p>

<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Rundeck Documentation</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://rundeck.com" property="cc:attributionName" rel="cc:attributionURL">Rundeck, Inc</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
<p>
&copy;2019 <a href="http://rundeck.com">Rundeck</a>
</p>
<p>
<span class="generated-date" title="2019-01-15T03:05:51UTC">2019-01-15T03:05:51UTC</span>
</p>
</footer>
</div>
</div>
<script type="text/javascript">
  

   var _gaq = [['_setAccount', 'UA-529275-13'], ['_trackPageview']];
   (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
   })(document, 'script');
  </script>

<script>window.markdeepOptions={mode:'html'};</script>
<!-- Markdeep: --><script src="../markdeep.min.js"></script>
<!-- <script src="https://casual-effects.com/markdeep/latest/markdeep.min.js"></script> -->

<!-- Start of HubSpot Embed Code -->
<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/2768099.js"></script>
<!-- End of HubSpot Embed Code -->
</body>
</html>
